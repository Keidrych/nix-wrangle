
# Here's our derivation, nix/default.nix. It expects a \`piep\` argument, and doesn't have its own `src`:
$ cat nix/default.nix
{ stdenv, piep }:
stdenv.mkDerivation {
  name="sample.txt";
  src = null;
  buildCommand = ''
    cat > "$out" <<EOF
      Sample derivation, built from:
       - self: $src
       - piep: ${piep}
    EOF
  '';
}

# Initialize nix/wrangle.json (pass `--pkgs nixos-unstable` to pin nixpkgs version):
$ nix-wrangle init
Adding "nix-wrangle" // PackageSpec {sourceSpec = Github (GithubSpec {ghOwner = "timbertson", ghRepo = "nix-wrangle", ghRef = Template "v1"}), fetchAttrs = fromList [], packageAttrs = fromList [("nix","default.nix")]}
fetching Github (GithubSpec {ghOwner = "timbertson", ghRepo = "nix-wrangle", ghRef = Template "v1"})
Resolved nix-wrangle -> v1 -> 1583199d2c4ff5533780e48f483488b6bef2f238
 - sha256:1xb87hcqpc60pjjfjnk10n1clrnzl9z8xjzrjk9h5dgkmih7x5gb
Writing: nix/wrangle.json
Writing: default.nix

# Add `self`, which will replace `src` in the toplevel derivation.

# The path is `..` because we're in a subdirectory - normally this would just be `.`
$ nix-wrangle add self --type git-local ..
Reading sources: nix/wrangle.json
Adding "self" // PackageSpec {sourceSpec = GitLocal (GitLocalSpec {glPath = RelativePath "..", glRef = Template "HEAD"}), fetchAttrs = fromList [], packageAttrs = fromList [("nix","default.nix")]}
fetching GitLocal (GitLocalSpec {glPath = RelativePath "..", glRef = Template "HEAD"})
Writing: nix/wrangle.json

# Now provide the `piep` dependency from a github repo:
$ nix-wrangle add piep timbertson/piep --nix nix/
Reading sources: nix/wrangle.json
Adding "piep" // PackageSpec {sourceSpec = Github (GithubSpec {ghOwner = "timbertson", ghRepo = "piep", ghRef = Template "master"}), fetchAttrs = fromList [], packageAttrs = fromList [("nix","nix/")]}
fetching Github (GithubSpec {ghOwner = "timbertson", ghRepo = "piep", ghRef = Template "master"})
Resolved piep -> master -> d805330386553c5784ac7ef48ff38aea716575dc
 - sha256:1q7lzi3lggw8by4pkh5ckkjv68xqbjahrkxgdw89jxdlyd0wq5in
Writing: nix/wrangle.json

# When building, we need to disable build-use-chroot due to the `git-local` source
$ nix-build --option build-use-chroot false
trace: [wrangle] Loading /nix/store/fgz707z3n7mrrajlzfwx98d0ad4ajry0-source/nix/wrangle.json
trace: [wrangle] injecting src from `self` dependency
trace: [wrangle] Loading /home/tim/dev/nix/nix-wrangle/example/nix/wrangle.json
trace: [wrangle] injecting src from `self` dependency
trace: [wrangle] Importing piep from /nix/store/ax68rn4b8dc4lrcfqq4rhx2fcwdr807a-source/nix/
trace: Dereferenced git ref /home/tim/dev/nix/nix-wrangle/example/../.git/HEAD to ref: refs/heads/v1
trace: Dereferenced git ref /home/tim/dev/nix/nix-wrangle/example/../.git/refs/heads/v1 to 1583199d2c4ff5533780e48f483488b6bef2f238
these derivations will be built:
  /nix/store/sx0gd8wrwdb56xx4mi6d3hwgfsd9gjql-sample.txt.drv
building '/nix/store/sx0gd8wrwdb56xx4mi6d3hwgfsd9gjql-sample.txt.drv'...
/nix/store/bj1xpqnw8qfnrzyj3cppid5w6ydlbhcc-sample.txt

# And here's the result, with injected source and `piep` dependency:
$ cat result
  Sample derivation, built from:
   - self: /nix/store/6h3kaq6wqgcmkv9vwqavanpwc5fy4mgj-git-export
   - piep: /nix/store/7fysz0cm3686f7hkhdk76kws4p8rswa2-python2.7-piep-0.8.1
